<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Host-only networking set up for QEMU hypervisor - Andrew Albershtein</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="https://alberand.github.io/theme/bootstrap.css" rel="stylesheet" />
    <!--<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" rel="stylesheet" />-->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://alberand.github.io/theme/style.css" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://alberand.github.io">Andrew Albershtein</a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="https://alberand.github.io/tags.html">Tags</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
    <section id="content" class="article content">
      <header>
        <h2 class="entry-title">
          Host-only networking set up for QEMU hypervisor
        </h2>
        
        <div class="text-muted" style="float: left; margin-right: 20px;">24.03.2017</div>
        <div class="text-muted">
            <a href="https://alberand.github.io/category/misc.html"><div class="fa fa-lg fa-folder-open"></div> Misc</a>
            <a href="https://alberand.github.io/tag/qemu.html"><div class="fa fa-lg fa-tag"></div> qemu</a>
            <a href="https://alberand.github.io/tag/linux.html"><div class="fa fa-lg fa-tag"></div> linux</a>
            <a href="https://alberand.github.io/tag/networking.html"><div class="fa fa-lg fa-tag"></div> networking</a>
        </div>
      </header>
<!-- .entry-content -->
      <div class="entry-content">
        <p>In this short note you can find approach to set up host-only network for QEMU
hypervisor. It means that guest system (run in QEMU) will be in LAN connection
with host system (your machine). I used it for for experiments with SSH 
functionality of a guest system.</p>
<p>Connection will be establish by virtual bridge and virtual TAP interface. After
host setup you will need assign IP address to the guest system (if it doesn't do
automatically) and you can use it remotely. </p>
<p>Firstly, create bridge on the host machine:</p>
<div class="highlight"><pre><span></span>sudo ip link add br0 <span class="nb">type</span> bridge
</pre></div>


<p>If use already created bridge don't forgot to clean out IP.</p>
<div class="highlight"><pre><span></span>sudo ip addr flush dev br0
</pre></div>


<p>Assign IP to the bridge.</p>
<div class="highlight"><pre><span></span>sudo ip addr add <span class="m">192</span>.168.100.50/24 brd <span class="m">192</span>.168.100.255 dev br0
</pre></div>


<p>Create TAP interface.</p>
<div class="highlight"><pre><span></span>sudo ip tuntap add mode tap user <span class="k">$(</span>whoami<span class="k">)</span>
ip tuntap show
</pre></div>


<p>Output should contains name of created TAP interface:</p>
<div class="highlight"><pre><span></span>~ tap0: tap UNKNOWN_FLAGS:800 user <span class="m">1000</span>
</pre></div>


<p>Add TAP interface to the bridge.</p>
<div class="highlight"><pre><span></span>sudo ip link <span class="nb">set</span> tap0 master br0
</pre></div>


<p>Make sure everything up:</p>
<div class="highlight"><pre><span></span>sudo ip link <span class="nb">set</span> dev br0 up
sudo ip link <span class="nb">set</span> dev tap0 up
</pre></div>


<p>Assign IP's range to bridge.</p>
<div class="highlight"><pre><span></span>sudo dnsmasq --interface<span class="o">=</span>br0 --bind-interfaces <span class="se">\</span>
    --dhcp-range<span class="o">=</span><span class="m">192</span>.168.100.50,192.168.100.254
</pre></div>


<p>Make sure that interfaces are UP. If not run previously mentioned command to set
TAP interface up (br0 will change its state automatically). Run qemu:</p>
<div class="highlight"><pre><span></span>qemu -device e1000,netdev<span class="o">=</span>network0,mac<span class="o">=</span><span class="m">52</span>:55:00:d1:55:01 <span class="se">\</span>
        -netdev tap,id<span class="o">=</span>network0,ifname<span class="o">=</span>tap0,script<span class="o">=</span>no,downscript<span class="o">=</span>no
</pre></div>


<p>Assign static IP address to qemu for further work.</p>
<div class="highlight"><pre><span></span>ip addr add 192.168.100.224/24 broadcast 192.168.100.255 dev eth0
</pre></div>


<p>Don't forgot to add root password:</p>
<div class="highlight"><pre><span></span>passwd
</pre></div>


<p>Now you can connect to the qemu virtual machine using SSH:</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">root</span><span class="mf">@192.168.100.224</span>
</pre></div>


<h4>Troubleshooting</h4>
<p>If you get error that tap0 already in use possibly you are trying to run more
than one version QEMU for one TAP interface. Described approach is used only for
two peers (host and guest). For multiple connection you need further
configuration.</p>
<p>As mentioned before make sure that both interfaces as TAP as Bridge are up.
Otherwise you will fail to connect via SSH.</p>
<h4>References</h4>
<ul>
<li><a href="http://www.qemu-project.org/">QEMU?</a></li>
<li><a href="https://en.wikipedia.org/wiki/TUN/TAP">TUN/TAP?</a></li>
</ul>
      </div>
<!-- /.entry-content 
      <footer class="post-info text-muted">
      </footer>-->
      <!-- /.post-info -->
    </section>
    </div>
    <!--
    <footer class="footer">
      <div class="container">
        <p class="footer-text">&copy; <a href="https://alberand.github.io">Andrew Albershtein</a> powered by <a href="http://getpelican.com/">pelican</a></p>
      </div>
    </footer>
    //-->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>